/**
 * @file treegrid.js
 *
 * @brief
 * TreeGrid is a visualization which represents data in a hierarchical grid
 * view. It is designed to handle large amouts of data, and has options for lazy
 * loading. Items in the TreeGrid can contain custom HTML code. Information in
 * one item can be spread over multiple columns, and can have action buttons on
 * the right.
 * TreeGrid offers built in functionality to sort, arrange, and filter items.
 *
 * TreeGrid is part of the CHAP Links library.
 *
 * TreeGrid is tested on Firefox 3.6, Safari 5.0, Chrome 6.0, Opera 10.6, and
 * Internet Explorer 9+.
 *
 * @license
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a copy
 * of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 *
 * Copyright (c) 2011-2015 Almende B.V.
 *
 * @author   Jos de Jong, <jos@almende.org>
 * @date     2015-11-20
 * @version  1.8.0
 */
"undefined"==typeof links&&(links={}),"undefined"==typeof google&&(google=void 0),links.TreeGrid=function(e,t){Array.prototype.indexOf||(Array.prototype.indexOf=function(e){for(var t=0;t<this.length;t++)if(this[t]==e)return t;return-1}),this.options={width:"100%",height:"100%",padding:4,indentationWidth:20,items:{defaultHeight:24,minHeight:24},dropAreaHeight:0};try{void 0!=t.itemHeight&&console.log("WARNING: property option.itemHeight is no longer supported. It is changed to options.items.defaultHeight")}catch(i){}for(t&&links.TreeGrid.extend(this.options,t);e.hasChildNodes();)e.removeChild(e.firstChild);this.frame=new links.TreeGrid.Frame(e,this.options),this.frame.setTreeGrid(this),this.frame.repaint(),this.frame.reflow(),this.trigger("ready")},links.TreeGrid.extend=function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]instanceof Object?t[i]instanceof Object&&links.TreeGrid.extend(e[i],t[i]):e[i]=t[i])},links.TreeGrid.prototype.draw=function(e,t){t&&links.TreeGrid.extend(this.options,t);var i=new links.TreeGrid.Grid(e,this.options);this.frame.setGrid(i)},links.TreeGrid.prototype.redraw=function(){this.frame&&this.frame.onRangeChange()},links.TreeGrid.prototype.expand=function(e){links.TreeGrid.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++){var i=e[t],r=this.frame.findItem(i);r&&r.expand()}},links.TreeGrid.prototype.collapse=function(e){links.TreeGrid.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++){var i=e[t],r=this.frame.findItem(i);r&&r.collapse()}},links.TreeGrid.prototype.getSelection=function(){return this.frame.getSelection()},links.TreeGrid.prototype.setSelection=function(e){this.frame.setSelection(e)},links.TreeGrid.Node=function(){this.top=0,this.width=0,this.left=0,this.height=0,this.visible=!0,this.selected=!1},links.TreeGrid.Node.prototype.setParent=function(e){this.parent=e},links.TreeGrid.Node.prototype.getAbsTop=function(){return(this.parent?this.parent.getAbsTop():0)+this.top},links.TreeGrid.Node.prototype.getAbsLeft=function(){return(this.parent?this.parent.getAbsLeft():0)+this.left},links.TreeGrid.Node.prototype.getHeight=function(){return this.height},links.TreeGrid.Node.prototype.getWidth=function(){return this.width},links.TreeGrid.Node.prototype.getLeft=function(){return this.left},links.TreeGrid.Node.prototype.getTop=function(){return this.top},links.TreeGrid.Node.prototype.setLeft=function(e){this.left=e||0},links.TreeGrid.Node.prototype.setTop=function(e){this.top=e||0},links.TreeGrid.Node.prototype.getTreeGrid=function(){return this.parent?this.parent.getTreeGrid():void 0},links.TreeGrid.Node.prototype.getSelection=function(){return this.parent?this.parent.getSelection():[]},links.TreeGrid.Node.prototype.getContainer=function(){return this.parent?this.parent.getContainer():void 0},links.TreeGrid.Node.prototype.getVisibleWindow=function(){return this.parent?this.parent.getVisibleWindow():{top:0,left:0,width:0,height:0}},links.TreeGrid.Node.prototype.setVisible=function(e){this.visible=1==e},links.TreeGrid.Node.prototype.isVisible=function(){return this.visible&&(this.parent?this.parent.isVisible():!0)},links.TreeGrid.Node.prototype.updateHeight=function(e,t){},links.TreeGrid.Node.prototype.onUpdateHeight=function(e){this.parent&&this.parent.updateHeight(this,e)},links.TreeGrid.Node.prototype.repaint=function(){return!1},links.TreeGrid.Node.prototype.reflow=function(){},links.TreeGrid.Node.prototype.update=function(){},links.TreeGrid.Node.prototype.hide=function(){this.setVisible(!1),this.repaint(),this.reflow()},links.TreeGrid.Node.prototype.show=function(){this.setVisible(!0),this.repaint()},links.TreeGrid.Node.prototype.select=function(){this.selected=!0},links.TreeGrid.Node.prototype.unselect=function(){this.selected=!1},links.TreeGrid.Node.prototype.onResize=function(){this.parent&&this.parent.onResize&&this.parent.onResize()},links.TreeGrid.Node.createActionIcons=function(e,t){var i,r=document.createElement("DIV");r.style.position="absolute",r.className="treegrid-actions",r.style.top="0px",r.style.right="24px";for(var n=0,o=t.length;o>n;n++){var s=t[n];s.event&&(s.image?(i=document.createElement("INPUT"),i.treeGridType="action",i.type="image",i.className="treegrid-action-image",i.title=s.title||"",i.src=s.image,i.event=s.event,i.id=s.id,i.item=e,i.style.width=s.width||"",i.style.height=s.height||"",r.appendChild(i)):(i=document.createElement("A"),i.treeGridType="action",i.className="treegrid-action-link",i.href="#",i.title=s.title||"",i.innerHTML=s.text?s.text:s.event,i.event=s.event,i.id=s.id,i.item=e,i.style.width=s.width||"",i.style.height=s.height||"",r.appendChild(i)))}return r},links.TreeGrid.Frame=function(e,t){this.options=t,this.container=e,this.dom={},this.frameWidth=0,this.frameHeight=0,this.grid=void 0,this.eventParams={},this.selection=[],this.top=0,this.left=0,this.window={left:0,top:0,height:0,width:0},this.hoveredItem=null,this.repaint()},links.TreeGrid.Frame.prototype=new links.TreeGrid.Node,links.TreeGrid.Frame.prototype.findItem=function(e){return this.grid?this.grid.findItem(e):null},links.TreeGrid.Frame.prototype.trigger=function(e,t){if(!this.treegrid)throw"Error: cannot trigger an event because treegrid is missing";this.treegrid.trigger(e,t)},links.TreeGrid.Frame.findFrame=function(e){for(;e;){if(e instanceof links.TreeGrid.Frame)return e;e=e.parent}return null},links.TreeGrid.Frame.prototype.getContainer=function(){return this.dom.itemFrame},links.TreeGrid.Frame.prototype.getTreeGrid=function(){return this.treegrid},links.TreeGrid.Frame.prototype.setTreeGrid=function(e){this.treegrid=e},links.TreeGrid.Frame.prototype.setGrid=function(e){this.grid&&(this.grid.hide(),delete this.grid),this.grid=e,this.grid.setParent(this),this.gridHeight=this.grid.getHeight(),this.update(),this.repaint()},links.TreeGrid.Frame.prototype.getAbsTop=function(){return this.verticalScroll?-this.verticalScroll.get():0},links.TreeGrid.Frame.prototype.onResize=function(){this.repaint();for(var e=0,t=10;this.reflow()&&t>e;)this.update(),this.repaint(),e++;if(e>=t)try{console.log("Warning: maximum number of loops exceeded")}catch(i){}},links.TreeGrid.Frame.prototype.onRangeChange=function(){this._updateVisibleWindow(),this.update(),this.repaint();var e=0,t=10;for(this.reflow();this.reflow();)this.repaint();if(e>=t)try{console.log("Warning: maximum number of loops exceeded")}catch(i){}},links.TreeGrid.Frame.prototype.getVisibleWindow=function(){return this.window},links.TreeGrid.Frame.prototype.update=function(){this.grid&&this.grid.update()},links.TreeGrid.Frame.prototype._updateVisibleWindow=function(){var e=this.grid,t=this.frameHeight,i=this.frameWidth,r=e?e.getTop():0,n=e?e.getHeight():0,o=this.verticalScroll?this.verticalScroll.get():0;n>0&&t>0&&o>0?this.top=(r+n-t)/(n-t)*o:this.top=0,this.window={left:this.left,top:this.top,height:t,width:i}},links.TreeGrid.Frame.prototype.reflow=function(){var e=!1,t=this.dom,i=(this.options,this.grid);if(i){var r=i.reflow();e=e||r}var n=t.mainFrame?t.mainFrame.clientHeight:0,o=t.mainFrame?t.mainFrame.clientWidth:0;return e=e||this.frameHeight!=n,e=e||this.frameWidth!=o,this.frameHeight=n,this.frameWidth=o,e&&(this.verticalScroll.setInterval(0,this.gridHeight-n),this._updateVisibleWindow()),this.verticalScroll.reflow(),e},links.TreeGrid.Frame.prototype.updateHeight=function(e,t){e==this.grid&&(this.gridHeight+=t)},links.TreeGrid.Frame.prototype.repaint=function(){this._repaintFrame(),this._repaintScrollbars(),this._repaintGrid()},links.TreeGrid.Frame.prototype._repaintFrame=function(){var e=this,t=this.dom,i=this.options,r=t.mainFrame;if(!r){r=document.createElement("DIV"),r.className="treegrid-frame",r.style.position="relative",r.style.overflow="hidden",r.style.left="0px",r.style.top="0px",r.frame=this,this.container.appendChild(r),t.mainFrame=r,links.TreeGrid.addEventListener(r,"mousedown",function(t){e.onMouseDown(t)}),links.TreeGrid.addEventListener(r,"mouseover",function(t){e.onMouseOver(t)}),links.TreeGrid.addEventListener(r,"mouseleave",function(t){e.onMouseLeave(t)}),links.TreeGrid.addEventListener(r,"mousewheel",function(t){e.onMouseWheel(t)}),links.TreeGrid.addEventListener(r,"touchstart",function(t){e.onTouchStart(t)});var n=document.createElement("div");n.innerHTML="1 item",n.className="treegrid-drag-image",this.dom.dragImage=n,links.dnd.makeDraggable(r,{dragImage:n,dragImageOffsetX:10,dragImageOffsetY:-10,dragStart:function(t){return e.onDragStart(t)}})}r.style.width=i.width||"100%",r.style.height=i.height||"100%";var o=t.itemFrame;o||(o=document.createElement("DIV"),o.style.position="absolute",o.style.left="0px",o.style.top="0px",o.style.width="100%",o.style.height="0px",t.mainFrame.appendChild(o),t.itemFrame=o)},links.TreeGrid.Frame.prototype._repaintGrid=function(){this.grid&&this.grid.repaint()},links.TreeGrid.Frame.prototype._repaintScrollbars=function(){var e=this.dom,t=e.scrollContainer;if(!t){t=document.createElement("div"),t.style.position="absolute",t.style.zIndex=9999,t.style.right="0px",t.style.top="0px",t.style.height="100%",t.style.width="16px",e.mainFrame.appendChild(t),e.scrollContainer=t;var i=this;verticalScroll=new links.TreeGrid.VerticalScroll(t),verticalScroll.addOnChangeHandler(function(e){i.onRangeChange()}),this.verticalScroll=verticalScroll}this.verticalScroll.redraw()},links.TreeGrid.isArray=function(e){return e instanceof Array?!0:"[object Array]"===Object.prototype.toString.call(e)},links.TreeGrid.Grid=function(e,t){this.setData(e),this.dom={},this.options={items:{defaultHeight:24,minHeight:24}},t&&links.TreeGrid.extend(this.options,t),this.columns=[],this.itemsHeight=0,this.items=[],this.itemCount=void 0,this.visibleItems=[],this.expandedItems=[],this.iconsWidth=0,this.headerHeight=0,this.header=new links.TreeGrid.Header({options:this.options}),this.header.setParent(this),this.loadingHeight=0,this.emptyHeight=0,this.errorHeight=0,this.height=this.options.items.defaultHeight,this.dropAreas=[],this.dropAreaHeight=this.options.dropAreaHeight,this.offset=0,this.limit=0},links.TreeGrid.Grid.prototype=new links.TreeGrid.Node,links.TreeGrid.Grid.prototype.update=function(){var e={offset:this.offset,limit:this.limit},t=this.getVisibleWindow(),i=this._getRangeFromWindow(t,e);this.offset=i.offset,this.limit=i.limit;for(var r=this,n=(this.items,this.offset),o=this.limit,s=links.TreeGrid.mergeArray(this.visibleItems,this.expandedItems),a=0,d=s.length;d>a;a++){var h=s[a];h&&h.update()}var l=function(e){r.error=void 0,r._updateItems(n,o)},p=function(e){r.error=e};this._getChanges(n,o,l,p)},links.TreeGrid.Grid.prototype.updateHeight=function(e,t){var i=-1;e instanceof links.TreeGrid.Header?(this.headerHeight+=t,i=-1):e instanceof links.TreeGrid.Item&&(this.itemsHeight+=t,i=this.items.indexOf(e));for(var r=this.items,n=i+1,o=r.length;o>n;n++){var s=r[n];s&&(s.top+=t)}},links.TreeGrid.Grid.prototype.onDrop=function(e){var t=e.dataTransfer.getData("items");if(this.dataConnector){for(var i=this,r=function(r){r&&r.items?(accepted=t.filter(function(e){return-1!==r.items.indexOf(e.data)}),e.dataTransfer.setData("items",accepted)):accepted=t;var n=links.TreeGrid.Frame.findFrame(i);if(n&&accepted.length>0){var o=i.items[f];if(n.select(o),accepted.length>1){var s=i.items[f+accepted.length-1];s&&n.select(s,!1,!0)}}var a=e.dataTransfer.getData("srcFrame");a.onDragEnd(e)},n=r,o=0;o<t.length;){for(var s=this;s&&s!=t[o];)s=s.parent;s==t[o]?t.splice(o,1):o++}for(var a=[],o=0;o<t.length;o++)a.push(t[o].data);if("move"==e.dataTransfer.dropEffect||"copy"==e.dataTransfer.dropEffect){var d=e.dropTarget&&e.dragSource===e.dropTarget.parent||e.dragSource===e.dropTarget.grid;if(e.dataTransfer.sameDataConnector=d,this.dataConnector.insertItemsBefore!==links.DataConnector.prototype.insertItemsBefore){var h,l=null;e.dropTarget instanceof links.TreeGrid.Item?(h=e.dropTarget,l=h.parent.items[h.index+1]):e.dropTarget instanceof links.TreeGrid.Header&&(h=e.dropTarget,l=h.parent.items[0]);var p=l&&l.data,f=l?l.index:this.itemCount;d?this.dataConnector.moveItems(a,p,r,n):this.dataConnector.insertItemsBefore(a,p,r,n)}else this.dataConnector.appendItems(a,r,n)}}else console.log("dropped but do nothing",e.dataTransfer.dropEffect);links.TreeGrid.preventDefault(e)},links.TreeGrid.mergeArray=function(e,t){for(var i=e.slice(0),r=0,n=t.length;n>r;r++){var o=t[r];-1==e.indexOf(o)&&i.push(o)}return i},links.TreeGrid.Grid.prototype.reflow=function(){var e=!1,t=this.visibleItems;if(this.header){var i=this.header.reflow();e=e||i}for(var r=links.TreeGrid.mergeArray(this.visibleItems,this.expandedItems),n=0,o=r.length;o>n;n++){var s=r[n];if(s){var a=s.reflow();e=e||a}}for(var d=this.dropAreas,n=0,o=d.length;o>n;n++)d[n].reflow();for(var h=this.header.getFieldWidths(),l=this.columns,p=this.options.indentationWidth,n=0,o=h.length;o>n;n++){var f=l[n];if(f&&!f.fixedWidth){var c=h[n]+p;c>f.width&&(f.width=c,e=!0)}}for(var n=0,o=t.length;o>n;n++)for(var s=t[n],h=s.getFieldWidths(),g=0,m=l.length;m>g;g++){var f=l[g];if(!f.fixedWidth){var c=h[g]+p;c>f.width&&(f.width=c,e=!0)}}if(this.isVisible()){for(var u=0,n=0,o=t.length;o>n;n++){var s=t[n],c=s.getIconsWidth();u=Math.max(c,u)}this.iconsWidth!=u&&(e=!0),this.iconsWidth=u}for(var v=p+this.iconsWidth,n=0,o=l.length;o>n;n++){var f=l[n];v!=f.left&&(f.left=v,e=!0),v+=f.width}var c=0;if(l&&l.length)var y=l[l.length-1],c=y.left+y.width;e=e||c!=this.width,this.width=c,this.loading?this.dom.loading&&(this.loadingHeight=this.dom.loading.clientHeight):this.loadingHeight=0,this.error?this.dom.error&&(this.errorHeight=this.dom.error.clientHeight):this.errorHeight=0,0==this.itemCount?this.dom.empty&&(this.emptyHeight=this.dom.empty.clientHeight):this.emptyHeight=0;var T=0;T+=this.headerHeight,T+=this.itemsHeight,T+=this.loadingHeight,T+=this.emptyHeight,0==T&&(T=this.options.items.defaultHeight);var k=T-this.height;return k&&(e=!0,this.height=T,this.onUpdateHeight(k)),e},links.TreeGrid.Grid.prototype.repaint=function(){var e=this;e.dom;this._repaintLoading(),this._repaintEmpty(),this._repaintError(),this._repaintHeader(),this._repaintItems(),window.count=window.count?window.count+1:1},links.TreeGrid.Grid.prototype._repaintLoading=function(){if(this.isVisible()&&void 0==this.itemCount&&!this.error){var e=this.dom.loadingIcon;e||(e=document.createElement("DIV"),e.className="treegrid-loading-icon",e.style.position="absolute",e.title="refreshing...",this.getContainer().appendChild(e),this.dom.loadingIcon=e),e.style.top=Math.max(this.getAbsTop(),0)+"px",e.style.left=this.getAbsLeft()+"px"}else this.dom.loadingIcon&&(this.dom.loadingIcon.parentNode.removeChild(this.dom.loadingIcon),this.dom.loadingIcon=void 0);if(this.isVisible()&&!this.error&&void 0==this.itemCount){var t=this.dom.loadingText;t||(t=document.createElement("div"),t.className="treegrid-loading",t.style.position="absolute",t.appendChild(document.createTextNode("loading...")),this.getContainer().appendChild(t),this.dom.loadingText=t),t.style.top=Math.max(this.getAbsTop(),0)+"px",t.style.left=this.getAbsLeft()+this.options.indentationWidth+"px"}else this.dom.loadingText&&(delete this.loadingHeight,this.dom.loadingText.parentNode.removeChild(this.dom.loadingText),this.dom.loadingText=void 0)},links.TreeGrid.Grid.prototype._repaintEmpty=function(){var e=this.dom;if(0==this.itemCount&&this.isVisible()){var t=e.empty;if(!t){t=document.createElement("div"),t.className="treegrid-loading",t.style.position="absolute",t.appendChild(document.createTextNode("(empty)")),this.getContainer().appendChild(t),e.empty=t;var i=this.parent,r=i.dataConnector?i.dataConnector.getOptions().dataTransfer:void 0;r&&links.dnd.makeDroppable(t,{dropEffect:r.dropEffect,drop:function(e){i.onDrop(e)},dragEnter:function(e){i.onDragEnter(e)},dragOver:function(e){i.onDragOver(e)},dragLeave:function(e){i.onDragLeave(e)}})}t.style.top=Math.max(this.getAbsTop(),0)+"px",t.style.left=this.getAbsLeft()+this.options.indentationWidth+"px",t.style.width=this.parent.width-2*this.options.indentationWidth+"px"}else e.empty&&(links.dnd.removeDroppable(t),e.empty.parentNode.removeChild(e.empty),delete this.dom.empty)},links.TreeGrid.Grid.prototype._repaintError=function(){var e=this.dom;if(this.isVisible()&&this.error){var t=e.error;t||(t=document.createElement("div"),t.className="treegrid-error",t.style.position="absolute",t.appendChild(document.createTextNode("Error: "+links.TreeGrid.Grid._errorToString(this.error))),this.getContainer().appendChild(t),e.error=t),t.style.top=Math.max(this.getAbsTop(),0)+"px",t.style.left=this.getAbsLeft()+this.options.indentationWidth+"px"}else e.error&&(e.error.parentNode.removeChild(e.error),e.error=void 0);if(this.isVisible()&&this.error&&!this.loading){var i=this.dom.errorIcon;i||(i=document.createElement("DIV"),i.className="treegrid-error-icon",i.style.position="absolute",i.title=this.error,this.getContainer().appendChild(i),this.dom.errorIcon=i);var r=this.getAbsLeft();i.style.top=Math.max(this.getAbsTop(),0)+"px",i.style.left=r+"px",i.style.zIndex=r+1}else this.dom.errorIcon&&(this.dom.errorIcon.parentNode.removeChild(this.dom.errorIcon),this.dom.errorIcon=void 0)},links.TreeGrid.Grid.prototype.getColumnsFromFields=function(e){var t=[];if(e){var i=0;for(var r in e)if(e.hasOwnProperty(r)){var n=e[r];"_"==r.charAt(0)||links.TreeGrid.isArray(n)||n instanceof links.DataConnector||(t[i]={name:r},i++)}}return t},links.TreeGrid.Grid.prototype.setColumns=function(e){for(var t=(this.options.indentationWidth,[]),i=!1,r=0,n=e.length;n>r;r++){var o=this.columns[r],s=e[r];if(o||(i=!0),!i)for(var a in s)if(o[a]!=s[a]){i=!0;break}if(!i)for(var a in o)if("width"!=a&&"left"!=a&&o[a]!=s[a]){i=!0;break}var d={name:"",width:0,left:0};!i&&o&&(void 0!=o.width&&(d.width=o.width),void 0!=o.left&&(d.left=o.left)),d.fixedWidth=void 0!=s.width;for(a in s)d[a]=s[a];this.columns[r]=d,t[r]=d}if(this.columns.length!=e.length&&(i=!0),i){this.columns.splice(0,this.columns.length);for(var r=0;r<t.length;r++)this.columns.push(t[r])}},links.TreeGrid.Grid.prototype.setData=function(e){var t=e!=this.data;if(t){var i;if(links.TreeGrid.isArray(e))i=new links.DataTable(e);else{if(!(e instanceof links.DataConnector))throw"Error: no valid data. JSON Array or DataConnector expected.";i=e}if(this.dataConnector&&this.eventListener){this.dataConnector.removeEventListener(this.eventListener),this.eventListener=void 0,this.dataConnector=void 0;for(var r=this.items,n=0,o=this.items.length;o>n;n++){var s=r[n];s&&(s.data=void 0)}}var a=this;this.eventListener=function(e,t){"change"==e&&a.update()},this.dataConnector=i,this.dataConnector.addEventListener(this.eventListener),this.dataConnector&&void 0!=this.dataConnector.options.showHeader?this.showHeader=this.dataConnector.options.showHeader:this.showHeader=!0}},links.TreeGrid.Grid.prototype._removeItem=function(e){var t=this.items,i=t.indexOf(e);if(-1!=i){e.expanded&&e.collapse();var r=this.visibleItems.indexOf(e);-1!=r&&this.visibleItems.splice(r,1);var n=e.getHeight();this.updateHeight(e,-n),e.hide(),t.splice(i,1),this.itemCount--;for(var o=i,s=t.length;s>o;o++)t[o].index=o}},links.TreeGrid.Grid.prototype._updateHeader=function(e){this.header.setFields(e)},links.TreeGrid.Grid.prototype._getChanges=function(e,t,i,r){for(var n=this,o=[],s=[],a=e,d=e+t;d>a;a++){var h=this.getItem(a);o.push(h.data),s.push(a)}for(var l=function(r){var s=r.items||[],a=o.length<t||s.length>0,d=r.totalItems!==n.itemCount;d&&n.setItemCount(r.totalItems);for(var h=e,l=e+t;l>h;h++){var p=n.getItem(h);p.updating=!1,p.data&&-1==s.indexOf(p.data)||(p.dirty=!0)}(d||a)&&n.onResize(),i&&i(s)},p=function(i){for(var o=e,s=e+t;s>o;o++){var a=n.getItem(o);a.error=i,a.updating=!1,a.dirty=!0}n.onResize(),r&&r(i)},a=0,d=s.length;d>a;a++){var f=s[a];this.items[f].updating=!0}this.dataConnector.getChanges(e,t,o,l,p)},links.TreeGrid.Grid.prototype._updateItems=function(e,t,i,r){for(var n=this,o=(this.items,this.getItem(e));t>0&&(o.loading||!o.dirty&&o.data);)e++,t--,o=this.getItem(e);for(o=this.getItem(e+t-1);t>0&&(o.loading||!o.dirty&&o.data);)t--,o=this.getItem(e+t-1);for(var s=e,a=e+t;a>s;s++){var o=this.getItem(s);(o.error||o.dirty||!o.data)&&(o.loading=!0,o.dirty=!0)}var d=function(r){for(var o=r.items,s=e,a=e+t;a>s;s++){var d=n.getItem(s);d.loading=!1,d.dirty=!1}for(var h=[],s=0,a=o.length;a>s;s++){var l=o[s],p=n.dataConnector.getOptions().columns||n.getColumnsFromFields(o[s]);if(p.length>h.length&&(h=p),n.setColumns(h),0==s&&n._updateHeader(n.columns),l){var f=e+s,d=n.getItem(f);d.data=l,d.setFields(l,n.columns),d.error=void 0}}n.onResize(),i&&i()},h=function(i){for(var o=e,s=e+t;s>o;o++){var a=n.getItem(o);a.loading=!1,a.dirty=!0,a.error=i}n.onResize(),r&&r(i)};t>0||void 0===this.totalItems?(this.repaint(),this.dataConnector.getItems(e,t,d,h)):i&&i()},links.TreeGrid.Grid.prototype._repaintHeader=function(){var e=this.showHeader&&void 0!=this.itemCount&&this.itemCount>0;this.header.setVisible(e),this.header.repaint()},links.TreeGrid.Grid.prototype._repaintItems=function(){for(var e=this.isVisible(),t=this.visibleItems,i=0;i<t.length;){var r=t[i];(r.index<this.offset||r.index>=this.offset+this.limit||!e)&&(r.hide(),t.splice(i,1),i--),i++}var n=this.itemCount||0,o=this.offset,s=Math.min(this.offset+this.limit,n);if(this.isVisible())for(var i=o;s>i;i++){var r=this.getItem(i);r.setVisible(!0),-1==t.indexOf(r)&&t.push(r)}for(var i=0;i<t.length;i++){var r=t[i];r.repaint()}},links.TreeGrid.Grid.prototype._repaintDropAreas=function(){var e="none";if(this.dataConnector&&this.dataConnector.options&&this.dataConnector.options.dataTransfer&&this.dataConnector.options.dataTransfer.dropEffect&&(e=this.dataConnector.options.dataTransfer.dropEffect),"none"!=e&&this.isVisible()){for(var t=this.itemCount||0,i=this.offset,r=Math.min(this.offset+this.limit,t),n=this.dropAreas,o=this.dropAreaHeight,s=(this.getContainer(),this.limit-n.length),a=-s,d=0;s>d;d++){var h=new links.TreeGrid.DropArea({dataConnector:this.dataConnector,item:this.getItem(this.offset+d),height:o});h.setParent(this),n.push(h)}for(var d=0;a>d;d++){var h=n.shift();h.hide()}for(var d=i;r>d;d++){var l=this.getItem(d),h=n[d-this.offset];h.setTop(l.top-o),h.item=l,h.repaint()}}else for(var n=this.dropAreas;n.length>0;){var h=n.shift();h.hide()}},links.TreeGrid.Grid.prototype.expand=function(e){links.TreeGrid.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++){var i=e[t],r=this.findItem(i);r&&r.expand()}},links.TreeGrid.Grid.prototype.collapse=function(e){links.TreeGrid.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++){var i=e[t],r=this.findItem(i);r&&r.collapse()}},links.TreeGrid.Grid.prototype.findItem=function(e){for(var t=0;t<this.items.length;t++){var i=this.items[t].findItem(e);if(i)return i}return null},links.TreeGrid.Header=function(e){e&&(this.height=e.height||0,this.options=e.options),this.fieldsHeight=0,this.dom={},this.columns=void 0},links.TreeGrid.Header.prototype=new links.TreeGrid.Node,links.TreeGrid.Header.prototype.clearFields=function(){this.columns=void 0,this.fieldsHeight=0},links.TreeGrid.Header.prototype.repaint=function(){if(this.isVisible()&&this.columns){var e=this.columns,t=this.prevColumns;e!=t&&(this.hide(),this.prevColumns=e);var i=this.dom.header;if(!i&&(i=document.createElement("DIV"),i.header=this,i.treeGridType="header",i.className="treegrid-header",i.style.position="absolute",i.style.zIndex=1+this.getAbsLeft(),this.getContainer().appendChild(i),this.dom.header=i,this.dom.fields=[],this.columns))for(var r=(this.options.padding,0),n=e.length;n>r;r++)if(!this.dom.fields[r]){var o=this.columns[r],s=document.createElement("DIV");s.className="treegrid-header-field"+(o.sortable?" treegrid-sortable":""),s.style.position="absolute",s.style.top="0px",s.innerHTML=o.text||o.name||"",s.title=o.title||"",i.appendChild(s),this.dom.fields[r]=s}var a=this.parent&&this.parent.dataConnector&&this.parent.dataConnector.actions;if(JSON.stringify(a)!==JSON.stringify(this.actions)){if(this.actions=a,this.dom.actions){var d=this.dom.actions.parentNode;d&&d.removeChild(this.dom.actions),delete this.dom.actions}if(a){var h=links.TreeGrid.Node.createActionIcons(this,a);this.dom.actions=h,i.appendChild(h)}}var l=this.parent&&this.parent.dataConnector&&this.parent.dataConnector.filters;if(!this.filters||JSON.stringify(l)!==JSON.stringify(this.filters)){this.filters=l;var p={asc:"&blacktriangledown;",desc:"&blacktriangle;","null":"&blacktriangle;&blacktriangledown;"};if(this.columns)for(var r=0,n=e.length;n>r;r++){var o=this.columns[r],s=this.dom.fields[r];if(s.domSort&&(s.removeChild(s.domSort),delete s.domSort),o.sortable){var f=this.parent.dataConnector,c=f.getSorting(),g=null;if(c)for(var m=0;m<c.length;m++)if(c[m].field==o.name){g=c[m];break}var u=document.createElement("SPAN"),v=g&&g.order;u.innerHTML=" "+p[g&&g.order],u.title="Sort this column",u.className="treegrid-order",s.appendChild(u),s.domSort=u,function(e,t,i){s.onclick=function(){f.setSorting([{field:e,type:t?t:"string",order:"asc"===i?"desc":"desc"===i?null:"asc"}])}}(o.name,o.sortableType,v)}}}var y=Math.max(this.getAbsTop(),0);i.style.top=y+"px",i.style.left=this.getAbsLeft()+"px",i.style.height=this.height+"px",i.style.width=this.width+"px";for(var T=this.dom.fields,r=0,n=Math.min(T.length,e.length);n>r;r++)T[r].style.left=e[r].left+"px"}else this.dom.header&&(this.dom.header.parentNode.removeChild(this.dom.header),this.dom.header=void 0,this.dom.fields=void 0)},links.TreeGrid.Header.prototype.reflow=function(){var e=!1,t=this.dom?this.dom.fields:void 0,i=t?t.length:0,r=this.options.items.minHeight;if(t){for(var n=0;i>n;n++)t[n]&&(r=Math.max(r,t[n].clientHeight));this.fieldsHeight=r}else this.columns||(this.fieldsHeight=0);var o=this.dom&&this.dom.actions,s=o?o.clientHeight:0;this.width=this.getVisibleWindow().width-this.getAbsLeft();var a=Math.max(this.fieldsHeight,s),d=a-this.height;return d&&(e=!0,this.height=a,this.onUpdateHeight(d)),e},links.TreeGrid.Header.prototype.onEvent=function(e){var t=this.parent.dataConnector,i={dataConnector:t||null};links.events.trigger(this.getTreeGrid(),e,i),t&&t._onEvent(e,i)},links.TreeGrid.Header.prototype.setFields=function(e){e&&(this.columns=e)},links.TreeGrid.Header.prototype.getFieldWidths=function(){var e=[];if(this.dom.fields)for(var t=this.dom.fields,i=0,r=t.length;r>i;i++)e[i]=t[i].clientWidth;return e},links.TreeGrid.Grid.prototype.setItemCount=function(e){var t=this.options.items.defaultHeight,i=e-(this.itemCount||0);if(i>0){var r=(t+this.dropAreaHeight)*i;this.itemsHeight+=r}if(0>i){for(var n=this.itemCount,o=e;n>o;o++){var s=this.items[o],a=s?s.getHeight():t;this.itemsHeight-=a+this.dropAreaHeight}for(var o=n;o<this.items.length;o++){var s=this.items[o];s&&(s.hide(),delete this.items[o])}0==e&&this.header.clearFields()}this.itemCount=e||0},links.TreeGrid.Grid.prototype.registerExpandedItem=function(e){var t=this.expandedItems.indexOf(e);-1==t&&this.expandedItems.push(e)},links.TreeGrid.Grid.prototype.unregisterExpandedItem=function(e){var t=this.expandedItems.indexOf(e);-1!=t&&this.expandedItems.splice(t,1)},links.TreeGrid.Grid.prototype.getItemCount=function(){return this.itemCount},links.TreeGrid.Grid.prototype.getItem=function(e){var t=this.items[e];return t||(t=new links.TreeGrid.Item({options:this.options,index:e,top:this._calculateItemTop(e),height:this.options.items.defaultHeight}),t.setParent(this),this.items[e]=t),t},links.TreeGrid.Grid.prototype._calculateItemTop=function(e){for(var t=this.items,i=this.options.items.defaultHeight,r=0,n=void 0,o=e-1;o>=0;o--){if(n=t[o],n&&n.top){r+=n.top+n.height;break}r+=i}var s=void 0!=n?r+this.dropAreaHeight:this.headerHeight+i*e+this.dropAreaHeight*(e+1);return s},links.TreeGrid.Item=function(e){e&&(this.options=e.options,this.index=e.index||0,this.top=e.top||0),this.height=this.options.items.defaultHeight,this.data=void 0,this.fields=void 0,this.fieldsHeight=0,this.grid=void 0,this.gridHeight=0,this.dirty=!1,this.loading=!1,this.loadingHeight=0,this.error=void 0,this.errorheight=0,this.dataTransfer={},this.dom={}},links.TreeGrid.Item.prototype=new links.TreeGrid.Node,links.TreeGrid.Item.prototype.findItem=function(e){return this.data===e?this:this.grid?this.grid.findItem(e):null},links.TreeGrid.eval=function(fn,obj){var t=typeof fn;if("function"==t)return fn.call(obj);if("string"==t){var evalHistory=links.TreeGrid.evalHistory;evalHistory||(evalHistory={},links.TreeGrid.evalHistory=evalHistory);var f=evalHistory[fn];return f||(f=eval("f=("+fn+");"),evalHistory[fn]=f),f.call(obj)}throw new Error("Function must be of type function or string")},links.TreeGrid.Item.prototype.setFields=function(e,t){if(e&&t){for(var i=[],r=0,n=t.length;n>r;r++){var o=t[r];o.format?i[r]=links.TreeGrid.eval(o.format,e)||"":i[r]=e[o.name]||""}this.fields=i,this.columns=t,this.icons=e._icons,this.actions=e._actions;var s=[];for(var a in e){if(e.hasOwnProperty(a)&&"_"!=a.charAt(0)){var d=e[a];links.TreeGrid.isArray(d)?s.push({name:a,data:new links.DataTable(d)}):d instanceof links.DataConnector&&s.push({name:a,data:d})}if("_childs"==a)try{console.log("WARNING: special field _childs encountered. This field is no longer in use for subgrids, and is now a regular hidden field. Use a fieldname without underscore instead for subgrids.")}catch(h){}}var l=void 0;if(1==s.length)l=s[0].data;else if(s.length>1){var p={showHeader:!1};l=new links.DataTable(s,p)}l?(this.dataConnector=l,this.grid&&(this.grid.setData(this.dataConnector),this.grid.update())):(this.dataConnector&&delete this.dataConnector,this.grid&&(this.grid.hide(),this.gridHeight=0,delete this.grid),this.expanded&&(this.expanded=!1,this.parent.unregisterExpandedItem(this)))}},links.TreeGrid.Item.prototype.getFieldWidths=function(){var e=[];if(this.dom.fields)for(var t=this.dom.fields,i=0,r=this.columns.length;r>i;i++)e[i]=t[i]?t[i].clientWidth:0;return e},links.TreeGrid.Item.prototype.getIconsWidth=function(){return this.dom.icons?this.dom.icons.clientWidth:0},links.TreeGrid.Item.prototype.updateHeight=function(e,t){e==this.grid&&(this.gridHeight+=t)},links.TreeGrid.Item.prototype.onEvent=function(e){var t={items:[this.data]};links.events.trigger(this.getTreeGrid(),e,t);var i=this.parent.dataConnector;i&&i._onEvent(e,t)},links.TreeGrid.Item.prototype._createGrid=function(){return this.grid||(this.grid=new links.TreeGrid.Grid(this.dataConnector,this.options),this.grid.setParent(this),this.grid.setLeft(this.left+this.options.indentationWidth),this.grid.setTop(this.height)),this.grid},links.TreeGrid.Item.prototype.expand=function(){this.expanded||this.dataConnector&&(this.expanded=!0,this.parent.registerExpandedItem(this),this.dom.buttonExpand&&(this.dom.buttonExpand.className="treegrid-unfold"),this._createGrid(),this.setVisible(!0),this.grid.setVisible(!0),this.gridHeight+=this.grid.getHeight()+this.options.padding,this.onEvent("expand"),this.onResize())},links.TreeGrid.Item.prototype.collapse=function(){this.expanded&&this.dataConnector&&(this.expanded=!1,this.parent.unregisterExpandedItem(this),this.dom.buttonExpand&&(this.dom.buttonExpand.className="treegrid-fold"),this.grid&&(this.grid.setVisible(!1),this.gridHeight-=this.grid.getHeight()+this.options.padding),this.onEvent("collapse"),this.onResize())},links.TreeGrid.Item.prototype.toggleExpand=function(){this.expanded?this.collapse():this.expand()},links.TreeGrid.Item.prototype.onDragOver=function(e){if(!this.dataTransfer.dragging){var t=this.fieldsHeight/2,i=(e.offsetY||e.layerY)<t||!this.dataConnector;return i=!1,this.dataTransfer.dragover=!i,this.dataTransfer.dragbefore=i,this.repaint(),links.TreeGrid.preventDefault(e),!1}},links.TreeGrid.Item.prototype.onDragEnter=function(e){return this.dataTransfer.dragging?void 0:!1},links.TreeGrid.Item.prototype.onDragLeave=function(e){return this.dataTransfer.dragging?void 0:(this.dataTransfer.dragover=!1,this.dataTransfer.dragbefore=!1,this.repaint(),!1)},links.TreeGrid.Item.prototype.onDrop=function(e){var t=e.dataTransfer.getData("items");if(this.dataTransfer.dragover=!1,this.dataTransfer.dragbefore=!1,this.repaint(),this.dataConnector){for(var i=this,r=function(t){i.expanded?i.onResize():i.expand(),t&&t.items&&(accepted=e.dataTransfer.getData("items").filter(function(e){
return-1!==t.items.indexOf(e.data)}),e.dataTransfer.setData("items",accepted));var r=e.dataTransfer.getData("srcFrame");r.onDragEnd(e)},n=r,o=0;o<t.length;){for(var s=this;s&&s!=t[o];)s=s.parent;s==t[o]?t.splice(o,1):o++}for(var a=[],o=0;o<t.length;o++)a.push(t[o].data);this.dataConnector.appendItems(a,r,n)}else if(this.parent&&this.parent.dataConnector&&"link"==e.dataTransfer.dropEffect){for(var d=this.data,r=function(e){},n=function(e){console.log(e)},h=[],o=0;o<t.length;o++)h.push(t[o].data);this.parent.dataConnector.linkItems(h,d,r,n)}else console.log("dropped but do nothing",e.dataTransfer.dropEffect);links.TreeGrid.preventDefault(e)},links.TreeGrid.Item.prototype.repaint=function(){this._repaintError(),this._repaintLoading(),this._repaintFields(),this._repaintGrid()},links.TreeGrid.Item.prototype.update=function(){this.grid&&this.expanded&&this.grid.update()},links.TreeGrid.Item.prototype.reflow=function(){var e=!1;if(this.grid&&this.expanded){var t=this.grid.reflow();e=e||t}if(this.width=this.getVisibleWindow().width-this.getAbsLeft(),this.isVisible()){var i=this.options.items.minHeight,r=this.dom.fields,n=this.dom.actions,o=this.dom.icons,s=this.dom.expandButton,a=r?r.length:0;if(o){var d=o.clientWidth;d!=this.iconsWidth&&(e=!0),this.iconsWidth=d}if(r||n||o||s||n){for(var h=0;a>h;h++)r[h]&&(i=Math.max(i,r[h].clientHeight));n&&(i=Math.max(i,n.clientHeight)),o&&(i=Math.max(i,o.clientHeight)),s&&(i=Math.max(i,s.clientHeight)),this.fieldsHeight=i}}this.loading?this.dom.loading&&(this.loadingHeight=this.dom.loading.clientHeight):this.loadingHeight=0,this.error?this.dom.error&&(this.errorHeight=this.dom.error.clientHeight):this.errorHeight=0;var l=0;l+=this.fieldsHeight,l+=this.loadingHeight,l+=this.errorHeight,l+=this.gridHeight,0==l&&(l=this.options.items.defaultHeight);var p=l-this.height;return p&&(e=!0,this.height=l,this.onUpdateHeight(p)),e},links.TreeGrid.Grid.prototype._getRangeFromWindow=function(e,t){var i,r,n,o,s=this.options.items.defaultHeight,a=void 0!=this.itemCount?this.itemCount:Math.ceil(e.height/s),d=-this.getAbsTop()+this.header.getHeight(),h=d+e.height-this.header.getHeight(),l=t?t.offset:0,p=0;for(i=this.items[l],r=i?i.top:this._calculateItemTop(l),n=i?i.getHeight():s,o=r+n;a-1>l&&d>o;)l++,i=this.items[l],r=o+this.dropAreaHeight,n=i?i.getHeight():s,o=r+n;for(;l>0&&r>d;)l--,i=this.items[l],n=i?i.getHeight():s,o=r,r=r-n-this.dropAreaHeight;for(;a-1>l+p&&h>r;)p++,i=this.items[l+p],r=o+this.dropAreaHeight,n=i?i.getHeight():s,o=r+n;return h>r&&o>d&&a>l+p&&p++,{offset:l,limit:p}},links.TreeGrid.Item.prototype._repaintFields=function(){var e;if(this.isVisible()&&this.fields){var t=this.fields,i=this.prevFields;t!=i&&(this.dom.frame&&(this.dom.frame.parentNode.removeChild(this.dom.frame),delete this.dom.frame),this.prevFields=t);var r=this.dom.frame;if(!r){var r=document.createElement("DIV");if(r.className="treegrid-item",r.style.position="absolute",r.item=this,r.treeGridType="item",this.dom.frame=r,this.dataConnector){var n=document.createElement("button");n.treeGridType="expand",n.className=this.expanded?"treegrid-unfold":"treegrid-fold",n.style.position="absolute",n.grid=this,n.node=this,n.index=this.index,r.appendChild(n),this.dom.buttonExpand=n}var o=this.icons;if(o){var s=document.createElement("DIV");s.className="treegrid-icons",s.style.position="absolute",s.style.top="0px";for(var a=0,d=o.length;d>a;a++){var h=o[a];if(h&&h.image){var l=document.createElement("img");l.className="treegrid-icon",l.src=h.image,l.title=h.title?h.title:"",l.style.width=h.width?h.width:"",l.style.height=h.height?h.height:"",s.appendChild(l)}}r.appendChild(s),this.dom.icons=s}var p=[];this.dom.fields=p;for(var t=this.fields,a=0,d=t.length;d>a;a++){var e=t[a],f=document.createElement("DIV");f.className="treegrid-item-field",f.style.position="absolute",f.style.top="0px";var c=this.columns[a];c&&c.fixedWidth&&(f.style.width=c.width+"px"),f.innerHTML=e,r.appendChild(f),p.push(f)}if(this.actions){var g=links.TreeGrid.Node.createActionIcons(this,this.actions);this.dom.actions=g,r.appendChild(g)}var m=this,u=this.dataConnector?this.dataConnector.getOptions().dataTransfer:void 0;if(u)void 0!=u.dropEffect&&"none"!=u.dropEffect&&(this.dataTransfer.dropEffect=u.dropEffect,links.dnd.makeDroppable(r,{dropEffect:u.dropEffect,drop:function(e){m.onDrop(e)},dragEnter:function(e){m.onDragEnter(e)},dragOver:function(e){m.onDragOver(e)},dragLeave:function(e){m.onDragLeave(e)}}));else if(this.parent&&this.parent.dataConnector){var u=this.parent.dataConnector.getOptions().dataTransfer;u&&"link"==u.dropEffect&&(this.dataTransfer.dropEffect=u.dropEffect,links.dnd.makeDroppable(r,{dropEffect:u.dropEffect,drop:function(e){m.onDrop(e)},dragEnter:function(e){m.onDragEnter(e)},dragOver:function(e){m.onDragOver(e)},dragLeave:function(e){m.onDragLeave(e)}}))}}r.parentNode||this.getContainer().appendChild(r);var v=this.getAbsLeft();r.style.top=this.getAbsTop()+"px",r.style.left=v+"px",r.style.height=this.fieldsHeight+"px",r.style.width=this.width-2+"px";var s=this.dom.icons;s&&(s.style.left=this.options.indentationWidth+"px");var p=this.dom.fields;if(p)for(var a=0,d=this.columns.length;d>a;a++){var c=this.columns[a],f=p[a];f&&(f.style.left=c.left+"px")}this.dom.buttonExpand&&(this.dom.buttonExpand.style.visibility=void 0==this.error?"visible":"hidden");var y="treegrid-item";y+=this.index%2?" treegrid-item-odd":" treegrid-item-even",y+=" treegrid-level-"+v/this.options.indentationWidth,this.selected||this.dataTransfer.dragging?y+=" treegrid-item-selected":this.dataTransfer.dragover?y+=" treegrid-item-dragover":this.dataTransfer.dragbefore&&(y+=" treegrid-item-dragbefore"),this.dirty&&(y+=" treegrid-item-dirty"),r.className=y}else links.dnd.removeDraggable(this.dom.frame),links.dnd.removeDroppable(this.dom.frame),this.dom.frame&&this.dom.frame.parentNode&&this.dom.frame.parentNode.removeChild(this.dom.frame),this.dom.frame&&(this.dom={})},links.TreeGrid.Item.prototype._repaintGrid=function(){this.grid&&this.grid.repaint()},links.TreeGrid.Item.prototype._repaintLoading=function(){if(this.isVisible()&&this.loading&&(!this.fields||this.error||this.dirty)){var e=this.dom.loadingIcon;e||(e=document.createElement("DIV"),e.className="treegrid-loading-icon",e.style.position="absolute",e.title="loading...",this.getContainer().appendChild(e),this.dom.loadingIcon=e),e.style.top=this.getAbsTop()+"px",e.style.left=this.getAbsLeft()+"px"}else this.dom.loadingIcon&&(this.dom.loadingIcon.parentNode.removeChild(this.dom.loadingIcon),delete this.dom.loadingIcon);if(this.isVisible()&&this.loading&&!this.fields&&!this.error){var t=this.dom.loadingText;t||(t=document.createElement("DIV"),t.style.position="absolute",t.appendChild(document.createTextNode("loading...")),t.className="treegrid-loading",this.getContainer().appendChild(t),this.dom.loadingText=t),t.style.top=this.getAbsTop()+"px",t.style.left=this.getAbsLeft()+this.options.indentationWidth+"px",t.style.height=this.height+"px"}else this.dom.loadingText&&(this.dom.loadingText.parentNode.removeChild(this.dom.loadingText),delete this.dom.loadingText)},links.TreeGrid.Item.prototype._repaintError=function(){if(this.isVisible()&&this.error&&!this.fields){var e=this.dom.error;e||(e=document.createElement("DIV"),e.style.position="absolute",e.appendChild(document.createTextNode("Error: "+links.TreeGrid.Grid._errorToString(this.error))),e.className="treegrid-error",this.getContainer().appendChild(e),this.dom.error=e),e.style.top=this.getAbsTop()+"px",e.style.left=this.getAbsLeft()+this.options.indentationWidth+"px"}else this.dom.error&&(this.dom.error.parentNode.removeChild(this.dom.error),delete this.dom.error);if(this.isVisible()&&this.error&&!this.loading){var t=this.dom.errorIcon;t||(t=document.createElement("DIV"),t.className="treegrid-error-icon",t.style.position="absolute",t.title=this.error,this.getContainer().appendChild(t),this.dom.errorIcon=t);var i=this.getAbsLeft();t.style.top=Math.max(this.getAbsTop(),0)+"px",t.style.left=i+"px"}else this.dom.errorIcon&&(this.dom.errorIcon.parentNode.removeChild(this.dom.errorIcon),this.dom.errorIcon=void 0)},links.TreeGrid.DropArea=function(e){e&&(this.dataConnector=e.dataConnector||void 0,this.item=e.item||void 0,this.top=e.top||0,this.height=e.height||6),this.dragover=!1,this.dom={}},links.TreeGrid.DropArea.prototype=new links.TreeGrid.Node,links.TreeGrid.DropArea.prototype.reflow=function(){this.width=this.getVisibleWindow().width-this.getAbsLeft()},links.TreeGrid.DropArea.prototype.repaint=function(){if(this.isVisible()){var e=this.dom.dropArea;if(!e){var t=this.getContainer();e=document.createElement("DIV"),e.style.position="absolute",e.style.left="0px",e.style.top="0px",e.style.height=this.height+"px",t.appendChild(e),this.dom.dropArea=e;var i=this.dataConnector?this.dataConnector.getOptions().dataTransfer:void 0;if(i){var r=this;this.dropEffect=i.dropEffect,links.TreeGrid.addEventListener(e,"dragover",function(e){return r.onDragOver(e)}),links.TreeGrid.addEventListener(e,"dragenter",function(e){return r.onDragEnter(e)}),links.TreeGrid.addEventListener(e,"dragleave",function(e){return r.onDragLeave(e)}),links.TreeGrid.addEventListener(e,"drop",function(e){return r.onDrop(e)})}}e.className=this.dragover?"treegrid-droparea":"",e.style.top=this.getAbsTop()+"px",e.style.left=this.getAbsLeft()+"px",e.style.width=this.width-2+"px"}else this.dom.dropArea&&(this.dom.dropArea.parentNode.removeChild(this.dom.dropArea),delete this.dom.dropArea)},links.TreeGrid.DropArea.prototype.onDragOver=function(e){return this.dragover=!0,e.dataTransfer.allowedEffect="none",e.dataTransfer.dropEffect=this.dropEffect||"none",this.repaint(),links.TreeGrid.preventDefault(e),!1},links.TreeGrid.DropArea.prototype.onDragEnter=function(e){return this.dragover=!0,this.repaint(),e.dataTransfer.allowedEffect="none",e.dataTransfer.dropEffect=this.dataConnector?"move":"none",!1},links.TreeGrid.DropArea.prototype.onDragLeave=function(e){return this.dragover=!1,this.repaint(),!1},links.TreeGrid.DropArea.prototype.onDrop=function(e){var t=JSON.parse(e.dataTransfer.getData("items"));if(this.dragover=!1,this.repaint(),this.dataConnector){var i=this,r=function(){i.parent.onResize()},n=r,o=[t.item],s=this.item.data;this.dataConnector.insertItemsBefore(o,s,r,n)}else console.log("dropped but do nothing",e.dataTransfer.dropEffect);links.TreeGrid.preventDefault(e)},links.TreeGrid.Grid._errorToString=function(e){if("string"==typeof e)return e;if(e instanceof Object){if(e.message&&"string"==typeof e.message)return e.message;if(e.error&&"string"==typeof e.error)return e.error;if(JSON)return JSON.stringify(e)}return String(e)},links.TreeGrid.VerticalScroll=function(e,t,i,r){this.container=e,this.dom={},this.height=0,this.min=0,this.max=0,this.value=0,this.eventParams={},this.onChangeHandlers=[],this.setInterval(t,i),this.set(r)},links.TreeGrid.VerticalScroll.prototype.redraw=function(){var e=this.dom.background;e||(e=document.createElement("div"),e.className="treegrid-verticalscroll-background",e.style.width="100%",e.style.height="100%",this.container.appendChild(e),this.dom.background=e);var t=this.dom.bar;if(!t){t=document.createElement("div"),t.className="treegrid-verticalscroll-bar",t.style.position="absolute",t.style.left="20%",t.style.width="60%",t.style.right="20%",t.style.top="0px",t.style.height="0px",this.container.appendChild(t);var i=this,r=this.eventParams;r._onMouseDown=function(e){i._onMouseDown(e)},links.TreeGrid.addEventListener(t,"mousedown",r._onMouseDown),this.dom.bar=t}var n=this.max-this.min;if(n>0){var o=this.height,s=2,a=Math.max(o*o/(n+o),20),d=this.value*(o-a-2*s)/n;t.style.height=a+"px",t.style.top=d+"px",t.style.display=""}else t.style.display="none"},links.TreeGrid.VerticalScroll.prototype.checkResize=function(){var e=this.reflow();return e&&this.redraw(),e},links.TreeGrid.VerticalScroll.prototype.reflow=function(){var e=!1;return this.height=this.dom.background.clientHeight,e},links.TreeGrid.VerticalScroll.prototype.setInterval=function(e,t){this.min=e||0,this.max=t||0,this.max<this.min&&(this.max=this.min),this.set(this.value)},links.TreeGrid.VerticalScroll.prototype.set=function(e){this.value=e||this.min,this.value<this.min&&(this.value=this.min),this.value>this.max&&(this.value=this.max),this.redraw()},links.TreeGrid.VerticalScroll.prototype.increase=function(e){var t=this.get();t+=e,this.set(t)},links.TreeGrid.VerticalScroll.prototype.get=function(){return this.value},links.TreeGrid.VerticalScroll.prototype._onMouseDown=function(e){var t=this.eventParams;e=e||window.event,t.startMouseX=e.clientX,t.startMouseY=e.clientY,t.startValue=this.value;var i=this;t._onMouseMove||(t._onMouseMove=function(e){i._onMouseMove(e)},links.TreeGrid.addEventListener(document,"mousemove",t._onMouseMove)),t._onMouseUp||(t._onMouseUp=function(e){i._onMouseUp(e)},links.TreeGrid.addEventListener(document,"mouseup",t._onMouseUp)),links.TreeGrid.preventDefault(e),links.TreeGrid.stopPropagation(e)},links.TreeGrid.VerticalScroll.prototype._onMouseMove=function(e){var t=this.eventParams;e=e||window.event;var i=e.clientX,r=e.clientY,n=(i-t.startMouseX,r-t.startMouseY),o=this.max-this.min,s=n/this.height*(o+this.height);this.set(t.startValue+s),this._callbackOnChangeHandlers(),links.TreeGrid.preventDefault(e),links.TreeGrid.stopPropagation(e)},links.TreeGrid.VerticalScroll.prototype._onMouseUp=function(e){var t=this.eventParams;t._onMouseMove&&(links.TreeGrid.removeEventListener(document,"mousemove",t._onMouseMove),t._onMouseMove=void 0),t.onMouseUp||(links.TreeGrid.removeEventListener(document,"mouseup",t._onMouseUp),t._onMouseUp=void 0),links.TreeGrid.preventDefault(e),links.TreeGrid.stopPropagation(e)},links.TreeGrid.VerticalScroll.prototype.addOnChangeHandler=function(e){this.removeOnChangeHandler(e),this.onChangeHandlers.push(e)},links.TreeGrid.VerticalScroll.prototype.removeOnChangeHandler=function(e){var t=this.onChangeHandlers.indexOf(e);this.onChangeHandlers.splice(t,1)},links.TreeGrid.VerticalScroll.prototype._callbackOnChangeHandlers=function(){for(var e=this.onChangeHandlers,t=this.value,i=0,r=e.length;r>i;i++)e[i](t)},links.DataConnector=function(e){this.options=e||{},this.eventListeners=[],this.expanded=!1},links.DataConnector.prototype.trigger=function(e,t){links.events.trigger(this,e,t),google&&google.visualization&&google.visualization.events&&google.visualization.events.trigger(this,e,t);for(var i=this.eventListeners,r=0,n=i.length;n>r;r++){var o=i[r];o(e,t)}},links.DataConnector.prototype.getChanges=function(e,t,i,r,n){throw"Error: method getChanges is not implemented"},links.DataConnector.prototype.getItems=function(e,t,i,r){r("Error: method getItems is not implemented")},links.DataConnector.prototype.updateItems=function(e,t,i){i("Error: method updateItems is not implemented")},links.DataConnector.prototype.appendItems=function(e,t,i){i("Error: method appendItems is not implemented")},links.DataConnector.prototype.insertItemsBefore=function(e,t,i,r){r("Error: method insertItemsBefore is not implemented")},links.DataConnector.prototype.moveItems=function(e,t,i,r){r("Error: method moveItems is not implemented")},links.DataConnector.prototype.removeItems=function(e,t,i){i("Error: method removeItems is not implemented")},links.DataConnector.prototype.linkItems=function(e,t,i,r){r("Error: method linkItems is not implemented")},links.DataConnector.prototype._onEvent=function(e,t){this.trigger(e,t),this.onEvent(e,t)},links.DataConnector.prototype.onEvent=function(e,t){},links.DataConnector.prototype.setFiltering=function(e){console.log("Error: method setFiltering is not implemented")},links.DataConnector.prototype.setSorting=function(e){console.log("Error: method setSorting is not implemented")},links.DataConnector.prototype.getFiltering=function(e){console.log("Error: method getFiltering is not implemented")},links.DataConnector.prototype.getSorting=function(e){console.log("Error: method getSorting is not implemented")},links.DataConnector.prototype.addEventListener=function(e){var t=this.eventListeners.indexOf(e);-1==t&&this.eventListeners.push(e)},links.DataConnector.prototype.removeEventListener=function(e){var t=this.eventListeners.indexOf(e);-1!=t&&this.eventListeners.splice(t,1)},links.DataConnector.prototype.setOptions=function(e){this.options=e||{}},links.DataConnector.prototype.getOptions=function(){return this.options},links.DataConnector.prototype.setActions=function(e){this.actions=e,this.trigger("change",void 0)},links.DataTable=function(e,t){this.data=e||[],this.setOptions(t),this.filteredData=this.data},links.DataTable.prototype=new links.DataConnector,links.DataTable.prototype.getItems=function(e,t,i,r){for(var n=[],o=this.filteredData,s=o.length,a=e,d=Math.min(e+t,s);d>a;a++)n.push(o[a]);i&&i({totalItems:o.length,items:n})},links.DataTable.prototype.updateItems=function(e,t,i){for(var r=e.length,n=this.data,o=0;r>o;o++){var s=e[o],a=n.indexOf(s);if(-1==a)return void(i&&i("Cannot find item"));n[a]={};for(var d in s)s.hasOwnProperty(d)&&(n[a][d]=s[d])}this._applySortingAndFilters(),t&&t({totalItems:this.filteredData.length,items:e}),this.trigger("change",void 0)},links.DataTable.prototype.appendItems=function(e,t,i){for(var r=e.length,n=0;r>n;n++)this.data.push(e[n]);this._applySortingAndFilters(),t&&t({totalItems:this.filteredData.length,items:e}),this.trigger("change",void 0)},links.DataTable.prototype.insertItemsBefore=function(e,t,i,r){var n=this.data,o=t?n.indexOf(t):n.length;return-1==o?void(r&&r("Cannot find item")):(n.splice.apply(n,[o,0].concat(e)),this._applySortingAndFilters(),i&&i({totalItems:this.filteredData.length,items:e}),void this.trigger("change",void 0))},links.DataTable.prototype.moveItems=function(e,t,i,r){var n=t?this.data.indexOf(t):this.data.length;if(-1==n)return void(r&&r("Cannot find item"));for(var o=e.length,s=[],a=0;o>a;a++){var d=this.data.indexOf(e[a]);if(-1==d)return void(r&&r("Cannot find item"));s[a]=d}s.sort(function(e,t){return e>t?1:t>e?-1:0});for(var h=0,a=o-1;a>=0;a--){var d=s[a];n>d&&h++,this.data.splice(d,1)}this.data.splice.apply(this.data,[n-h,0].concat(e)),this._applySortingAndFilters(),i&&i({totalItems:this.filteredData.length,items:e}),this.trigger("change",void 0)},links.DataTable.prototype.removeItems=function(e,t,i){for(var r=e.length,n=0;r>n;n++){var o=this.data.indexOf(e[n]);if(-1==o)return void(i&&i("Cannot find item"));this.data.splice(o,1)}this._applySortingAndFilters(),t&&t({totalItems:this.filteredData.length,items:e}),this.trigger("change",void 0)},links.DataTable.prototype.getChanges=function(e,t,i,r,n){for(var o=[],s=this.filteredData,a=(s.length,0);t>a;a++){var d=i[a];d!=s[e+a]&&o.push(d)}r&&r({totalItems:this.filteredData.length,items:o})},links.DataTable.prototype.update=function(){this._applySortingAndFilters(),this.trigger("change",void 0)},links.DataTable.prototype.onEvent=function(e,t){},links.DataTable.prototype.setFiltering=function(e){this.filters=e,this._applySortingAndFilters(),this.trigger("change",void 0)},links.DataTable.prototype.getFiltering=function(){return this.sorting},links.DataTable.prototype.setSorting=function(e){this.sorting=e,this._applySortingAndFilters(),this.trigger("change",void 0)},links.DataTable.prototype.getSorting=function(){return this.sorting},links.DataTable.prototype._applySortingAndFilters=function(){if(this.filters){this.filteredData=[];for(var e=0,t=this.data.length;t>e;e++){for(var i=this.data[e],r=!0,n=0,o=this.filters.length;o>n;n++){var s=this.filters[n];if(s.field){var a=i[s.field];s.value&&a!=s.value&&(r=!1),s.startValue&&a<s.startValue&&(r=!1),s.endValue&&a>s.endValue&&(r=!1),s.values&&-1==s.values.indexOf(a)&&(r=!1)}}r&&this.filteredData.push(i)}}else this.filteredData=this.data.slice(0);if(this.sorting){for(var d=[],n=0,o=this.sorting.length;o>n;n++){var h=this.sorting[n];if(h.field&&h.order&&h.type){var l=h.order.toLowerCase();if("asc"!=l&&"desc"!=l)throw'Unknown order "'+l+'". Available values: "asc", "desc".';d.push({field:h.field,type:h.type,direction:"asc"==l?1:-1})}}var p=d.length;p>0&&this.filteredData.sort(function(e,t){for(var i=0;p>i;i++){var r=d[i],n=r.field,o=r.type,s=r.direction,a=e[n]?"date"==o?new Date(e[n]):e[n].toLowerCase():"",h=t[n]?"date"==o?new Date(t[n]):t[n].toLowerCase():"";if(a!=h)return a>h?s:-s;if(i==p-1)return 0}})}},links.CouchConnector=function(e){this.url=e,this.data=[],this.filter=void 0,this.updateSeq=void 0,this.blockSize=16,this.totalItems=this.blockSize},links.CouchConnector.prototype=new links.DataConnector,links.CouchConnector.prototype.getItems=function(e,t,i,r){function n(e,t){for(var i=[],r=e,n=e+t;n>r;r++){var o=s[r];i.push(o?o.value:void 0)}return i}for(var o=this,s=this.data,a=!0,d=e,h=e+t;h>d;d++)if(void 0==s[d]){a=!1;break}if(a){var l=!1;l&&(this.data=[],s=this.data,a=!1)}if(a){var p=n(e,t);i({totalItems:o.totalItems,items:p})}else{for(var f=e%this.blockSize,c=e-f,g=(t+f)%this.blockSize,m=t+f-g+(0!=g?this.blockSize:0);s[c]&&m>0;)c++,m--;for(;s[c+m-1]&&m>0;)m--;for(var u=void 0,v=c-1;v>0&&void 0==s[v];)v--;s[v]&&(u=s[v].key);var y,T=-1==this.url.indexOf("?")?"?":"&";u?y=this.url+T+"skip="+(c-v)+"&limit="+m+"&startkey="+escape(JSON.stringify(u)):(y=this.url+T+"skip="+c+"&limit="+m,this.filter&&(void 0!=this.filter.value&&(y+="&key="+escape(JSON.stringify(this.filter.value))),void 0!=this.filter.startValue&&(y+="&startkey="+escape(JSON.stringify(this.filter.startValue))),void 0!=this.filter.endValue&&(y+="&endkey="+escape(JSON.stringify(this.filter.endValue))))),links.getJSONP(y,function(a){if(a.error)return void r(a);for(var d=a.rows,h=[],l=0,p=d.length;p>l;l++)s[l+c]=d[l];o.totalItems=Math.min(o.data.length+o.blockSize,a.total_rows);var h=n(e,t);i({totalItems:o.totalItems,items:h})},r)}},links.CouchConnector.prototype._getUpdateSeq=function(e,t){var i=this.url.indexOf("_view");if(-1==i)return void t("Error: cannot get information on this view, url is no view");var r=this.url.substring(0,i)+"_info";links.getJSONP(r,function(i){if(data.error)return void t(data);var r=i.view_index.update_seq;e(r)},t)},links.CouchConnector.prototype.getChanges=function(e,t,i,r,n){var o=[];return r({totalItems:this.totalItems||10,items:o}),o},links.CouchConnector.prototype.setFiltering=function(e){if(e.length>1)throw"CouchConnector can currently only handle one filter";e.length>0&&(this.filter=e[0])},links.CouchConnector.prototype.setSorting=function(e){if(filters.length>1)throw"CouchConnector can currently only handle one order";e.length>0&&(this.sorting=e[0])},links.getJSONP=function(e,t,i){var r="callback"+Math.round(1e10*Math.random()),n=document.createElement("script"),o=-1==e.indexOf("?")?"?":"&";n.src=e+o+"callback="+r,n.onerror=function(e){document.body.removeChild(n),delete window[r],i&&i()},n.type="text/javascript",window[r]=function(e){document.body.removeChild(n),delete window[r],t&&t(e)},document.body.appendChild(n)},links.TreeGrid.Frame.prototype.onDragStart=function(e){for(var t=[],i=0;i<this.selection.length;i++){var r=this.selection[i],n=r.parent,o=n?n.dataConnector:void 0,s=o?o.options:void 0,a=s?s.dataTransfer:void 0,d=a?a.allowedEffect:void 0;void 0!=d&&"none"!=d.toLowerCase()&&t.push(r)}if(e.dragSource=n,t.length>0){var h=this.dom.dragImage;if(h){var l=t.length;h.innerHTML=l+" item"+(1!=l?"s":"")}return e.dataTransfer.setData("items",t),e.dataTransfer.setData("srcFrame",this),!0}return!1},links.TreeGrid.Frame.prototype.onDragEnd=function(e){var t=e.dataTransfer.dropEffect;if("move"==t&&!e.dataTransfer.sameDataConnector)for(var i=this,r=e.dataTransfer.getData("items"),n=r.length,o=function(){n--,0==n&&(i.unselect(),i.onResize())},s=o,a=0;a<r.length;a++){var d=r[a];d.parent._removeItem(d),d.parent.dataConnector.removeItems([d.data],o,s)}this.repaint()},links.TreeGrid.Frame.prototype.onMouseDown=function(e){e=e||window.event;var t=this.eventParams,i=e.which?1==e.which:1==e.button;if(i||t.touchDown){var r=links.TreeGrid.getTarget(e);if(r.treeGridType&&"expand"==r.treeGridType)r.grid.toggleExpand(),links.TreeGrid.stopPropagation(e);else if(r.treeGridType&&"action"==r.treeGridType)r.item.onEvent(r.event),links.TreeGrid.stopPropagation(e);else{var n=links.TreeGrid.getItemFromTarget(r);if(n){var o=e.ctrlKey,s=e.shiftKey;this.select(n,o,s)}else this.unselect()}links.TreeGrid.preventDefault(e)}},links.TreeGrid.Frame.prototype.onMouseOver=function(e){e=e||window.event;var t=links.TreeGrid.getItemFromTarget(e.target);this.hoveredItem!==t&&(this.hoveredItem&&this.trigger("leave",{item:this.hoveredItem.data}),t&&this.trigger("enter",{item:t.data}),this.hoveredItem=t||null)},links.TreeGrid.Frame.prototype.onMouseLeave=function(e){this.hoveredItem&&this.trigger("leave",{item:this.hoveredItem.data}),this.hoveredItem=null},links.TreeGrid.Frame.prototype.select=function(e,t,i){if(i){var r=this.selection.shift(),n=e;for(r&&r.parent!=n.parent&&(r.unselect(),r.repaint(),r=void 0),r||(r=n);this.selection.length;){var o=this.selection.pop();o.unselect(),o.repaint()}var s=r.parent,a=s.items.indexOf(r),d=r==n?a:s.items.indexOf(n);if(d>=a)for(var h=a;d>=h;){var e=s.items[h];e.select(),e.repaint(),this.selection.push(e),h++}else for(var h=a;h>=d;){var e=s.items[h];e.select(),e.repaint(),this.selection.push(e),h--}}else if(t){var h=this.selection.indexOf(e);-1==h?(e.select(),e.repaint(),this.selection.push(e)):(e.unselect(),e.repaint(),this.selection.splice(h,1))}else if(!e.selected){for(;this.selection.length;){var o=this.selection.pop();o.unselect(),o.repaint()}e.select(),e.repaint(),this.selection.push(e)}this.trigger("select",{items:this.getSelection()})},links.TreeGrid.Frame.prototype.unselect=function(e){for(var t=this.selection,i=0,r=t.length;r>i;i++)t[i].unselect(),t[i].repaint();this.selection=[],void 0==e&&(e=!0),e&&this.trigger("select",{items:[]})},links.TreeGrid.Frame.prototype.getSelection=function(){for(var e=this.selection,t=[],i=0,r=e.length;r>i;i++)t.push(e[i].data);return t},links.TreeGrid.Frame.prototype.setSelection=function(e){this.unselect(),e?links.TreeGrid.isArray(e)||(e=[e]):e=[];for(var t=!0,i=0;i<e.length;i++){var r=e[i],n=this.findItem(r);n&&this.select(n,t)}},links.TreeGrid.Frame.prototype.onTouchStart=function(e){var t=this.eventParams,i=this;t.touchDown||(t.startClientY=e.targetTouches[0].clientY,t.currentClientY=t.startClientY,t.previousClientY=t.startClientY,t.startScrollValue=this.verticalScroll.get(),t.touchDown=!0,t.onTouchMove||(t.onTouchMove=function(e){i.onTouchMove(e)},links.TreeGrid.addEventListener(document,"touchmove",t.onTouchMove)),t.onTouchEnd||(t.onTouchEnd=function(e){i.onTouchEnd(e)},links.TreeGrid.addEventListener(document,"touchend",t.onTouchEnd)))},links.TreeGrid.Frame.prototype.onTouchMove=function(e){var t=this.eventParams,i=e.targetTouches[0].clientY,r=i-t.startClientY;this.verticalScroll.set(t.startScrollValue-r),this.onResize(),t.previousClientY=t.currentClientY,t.currentClientY=i,this.trigger("rangechange",void 0),links.TreeGrid.preventDefault(e)},links.TreeGrid.Frame.prototype.onTouchEnd=function(e){var t=this.eventParams,i=this;t.touchDown=!1;var r=t.currentClientY-t.startClientY,n=t.currentClientY-t.previousClientY,o=function(){t.touchDown||(i.verticalScroll.set(t.startScrollValue-r),i.onRangeChange(),r+=n,n*=.8,Math.abs(n)>1&&setTimeout(o,50))};o(),this.trigger("rangechanged",void 0),t.onTouchMove&&(links.TreeGrid.removeEventListener(document,"touchmove",t.onTouchMove),delete t.onTouchMove),t.onTouchEnd&&(links.TreeGrid.removeEventListener(document,"touchend",t.onTouchEnd),delete t.onTouchEnd),links.TreeGrid.preventDefault(e)},links.TreeGrid.Frame.prototype.onMouseWheel=function(e){e||(e=window.event);var t=0;e.wheelDelta?t=e.wheelDelta/120:e.detail&&(t=-e.detail/3),t&&(this.verticalScroll.increase(50*-t),this.onRangeChange(),this.trigger("rangechanged",void 0)),links.TreeGrid.preventDefault(e)},links.TreeGrid.prototype.trigger=function(e,t){links.events.trigger(this,e,t),google&&google.visualization&&google.visualization.events&&google.visualization.events.trigger(this,e,t)},links.dnd=function(){function e(){return void 0!=T}function t(t,i){var r={element:t};i&&links.TreeGrid.extend(r,i),u.push(r);var n=function(t){t=t||window.event;var i=t.which?1==t.which:1==t.button;i&&(w=function(t){e()||o(t,r),s(t),c(t)},p(document,"mousemove",w),b=function(t){e()&&a(t),w&&(f(document,"mousemove",w),w=void 0),b&&(f(document,"mouseup",b),b=void 0),c(t)},p(document,"mouseup",b),c(t))};p(t,"mousedown",n),r.mouseDown=n}function i(e,t){var i={element:e,mouseOver:!1};t&&links.TreeGrid.extend(i,t),i.dropEffect||(i.dropEffect="link"),v.push(i)}function r(e){for(var t=0;t<u.length;){var i=u[t];i.element==e?(f(i.element,"mousedown",i.mouseDown),u.splice(t,1)):t++}}function n(e){for(var t=0;t<v.length;)v[t].element==e?v.splice(t,1):t++}function o(e,t){if(!T){T=t;var i=!0;if(T.dragStart){var r={};x={dataTransfer:{dragArea:T.element,dropArea:void 0,data:r,getData:function(e){return r[e]},setData:function(e,t){r[e]=t},clearData:function(e){delete r[e]}},clientX:e.clientX,clientY:e.clientY};var n=T.dragStart(x);i=n!==!1}if(!i)return void(T=void 0);var o=void 0;k=document.createElement("div"),k.style.position="absolute","string"==typeof T.dragImage?(k.innerHTML=T.dragImage,G=-T.dragImageOffsetX||0,C=-T.dragImageOffsetY||0):T.dragImage?(k.appendChild(T.dragImage),G=-T.dragImageOffsetX||0,C=-T.dragImageOffsetY||0):(o=T.element.cloneNode(!0),G=(e.clientX||0)-g(T.element),C=(e.clientY||0)-m(T.element),o.style.left="0px",o.style.top="0px",o.style.opacity="0.7",o.style.filter="alpha(opacity=70)",k.appendChild(o)),document.body.appendChild(k),void 0==I&&(I=document.body.style.cursor),document.body.style.cursor="move"}}function s(e){if(k){k&&(k.style.left=e.clientX-G+"px",k.style.top=e.clientY-C+"px"),x.clientX=e.clientX,x.clientY=e.clientY;var t=h(e);t?(x.dataTransfer.dropArea=t.element,x.dataTransfer.dropEffect=d(T.effectAllowed,t.dropEffect),t.dragOver&&t.dragOver(x)):(x.dataTransfer.dropArea=void 0,x.dataTransfer.dropEffect=void 0),T.drag&&T.drag(x)}}function a(e){k&&k.parentNode&&k.parentNode.removeChild(k),k=void 0,document.body.style.cursor=I||"",I=void 0;var t=h(e);t?(x.dataTransfer.dropArea=t.element,x.dataTransfer.dropEffect=d(T.effectAllowed,t.dropEffect),x.dataTransfer.dropEffect&&t.drop&&t.drop(x)):(x.dataTransfer.dropArea=void 0,x.dataTransfer.dropEffect=void 0),T.dragEnd&&T.dragEnd(x),T=void 0,x={}}function d(e,t){return t&&"none"!=t?e&&"all"!=e.toLowerCase()?-1!=e.toLowerCase().indexOf(t.toLowerCase())?t:void 0:t:void 0}function h(e){for(var t=null,i=null,r=e.target||e.srcElement;r;){if(r.item instanceof links.TreeGrid.Item){i=r.item;break}r=r.parentNode}if(i)for(var n=0;n<v.length;n++){var o=v[n];i.dom.frame==o.element&&!t&&d(T.effectAllowed,o.dropEffect)&&(t=o)}if(!t){var s=i&&i.parent;if(!s){var a=l(e.target||e.srcElement,"header");s=a&&a.parent}if(!s){var h=l(e.target||e.srcElement,"frame");s=h&&h.grid}if(s&&s.dataConnector&&!t&&d(s.dataConnector.options.dataTransfer.effectAllowed,s.dataConnector.options.dataTransfer.dropEffect)){var p=e.target||e.srcElement;if(y&&y.element===p)t=y;else{var f=document.createElement("div");f.className="treegrid-droparea after",t={element:p,dropEffect:s.dataConnector.options.dataTransfer.dropEffect,dragEnter:function(e){i?i.dom.frame.appendChild(f):a?(f.style.bottom="-5px",a.dom.header.appendChild(f)):h&&(f.style.top=h.gridHeight+"px",f.style.bottom="",h.dom.mainFrame.appendChild(f))},dragLeave:function(e){f.parentNode&&f.parentNode.removeChild(f)},dragOver:function(e){},drop:function(e){t.dragLeave(e),e.dropTarget=i||a||h,s.onDrop(e)}}}}}return y!==t&&(y&&(y.dragLeave&&(x.dataTransfer.dropArea=y,x.dataTransfer.dropEffect=void 0,y.dragLeave(x)),y.mouseOver=!1),t&&(t.dragEnter&&(x.dataTransfer.dropArea=t,x.dataTransfer.dropEffect=void 0,t.dragEnter(x)),t.mouseOver=!0),y=t),y}function l(e,t){for(;e;){if(e[t])return e[t];e=e.parentNode}return null}function p(e,t,i,r){e.addEventListener?(void 0===r&&(r=!1),"mousewheel"===t&&navigator.userAgent.indexOf("Firefox")>=0&&(t="DOMMouseScroll"),e.addEventListener(t,i,r)):e.attachEvent("on"+t,i)}function f(e,t,i,r){
e.removeEventListener?(void 0===r&&(r=!1),"mousewheel"===t&&navigator.userAgent.indexOf("Firefox")>=0&&(t="DOMMouseScroll"),e.removeEventListener(t,i,r)):e.detachEvent("on"+t,i)}function c(e){e||(e=window.event),e.preventDefault?e.preventDefault():e.returnValue=!1}function g(e){for(var t=0;null!=e;)t+=e.offsetLeft,e=e.offsetParent;return t}function m(e){for(var t=0;null!=e;)t+=e.offsetTop,e=e.offsetParent;return t}var u=[],v=[],y=null,T=void 0,k=void 0,G=0,C=0,x={},w=void 0,b=void 0,I=void 0;return{makeDraggable:t,makeDroppable:i,removeDraggable:r,removeDroppable:n}}(),links.events=links.events||{listeners:[],indexOf:function(e){for(var t=this.listeners,i=0,r=this.listeners.length;r>i;i++){var n=t[i];if(n&&n.object==e)return i}return-1},addListener:function(e,t,i){var r=this.indexOf(e),n=this.listeners[r];n||(n={object:e,events:{}},this.listeners.push(n));var o=n.events[t];o||(o=[],n.events[t]=o),-1==o.indexOf(i)&&o.push(i)},removeListener:function(e,t,i){var r=this.indexOf(e),n=this.listeners[r];if(n){var o=n.events[t];if(o){var s=o.indexOf(i);-1!=s&&o.splice(s,1),0==o.length&&delete n.events[t]}var a=0,d=n.events;for(var h in d)d.hasOwnProperty(h)&&a++;0==a&&delete this.listeners[r]}},removeAllListeners:function(){this.listeners=[]},trigger:function(e,t,i){var r=this.indexOf(e),n=this.listeners[r];if(n){var o=n.events[t];if(o)for(var s=0,a=o.length;a>s;s++)o[s](i)}}},links.TreeGrid.addEventListener=function(e,t,i,r){e.addEventListener?(void 0===r&&(r=!1),"mousewheel"===t&&navigator.userAgent.indexOf("Firefox")>=0&&(t="DOMMouseScroll"),e.addEventListener(t,i,r)):e.attachEvent("on"+t,i)},links.TreeGrid.removeEventListener=function(e,t,i,r){e.removeEventListener?(void 0===r&&(r=!1),"mousewheel"===t&&navigator.userAgent.indexOf("Firefox")>=0&&(t="DOMMouseScroll"),e.removeEventListener(t,i,r)):e.detachEvent("on"+t,i)},links.TreeGrid.getTarget=function(e){e||(e=window.event);var t;return e.target?t=e.target:e.srcElement&&(t=e.srcElement),void 0!==t.nodeType&&3==t.nodeType&&(t=t.parentNode),t},links.TreeGrid.getItemFromTarget=function(e){for(var t=e;t;){if("item"==t.treeGridType&&t.item)return t.item;t=t.parentElement}},links.TreeGrid.stopPropagation=function(e){e||(e=window.event),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0},links.TreeGrid.preventDefault=function(e){e||(e=window.event),e.preventDefault?e.preventDefault():e.returnValue=!1};